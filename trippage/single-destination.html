<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>코끼리 사파리 공원 - 트립페이지</title>
	<link rel="icon" type="image/png" href="img/icon/bavel.png">

	<!-- Meta Description -->
	<meta name="description" content="트립페이지 - 여행 상품 판매 및 여행 정보 제공">
	<meta name="keywords" content="여행, 여행상품, 여행사, 여행정보, 여행가이드">
	<meta name="robots" content="index, nofollow">
	<meta name="web_author" content="트립페이지">
	<meta name="language" content="Korean">  

	<!-- Import Icon -->
  	<link rel="stylesheet" type="text/css" href="css/ionicons.min.css">

	<!-- Import Style -->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/swiper.css">
	<link rel="stylesheet" type="text/css" href="css/single-destination.css">
    
    <!-- Import Scripts -->
    <script src="js/jquery.min.js"></script>
    <script src="js/toss-auth.js"></script>

	

</head>
<body style="background: #e6eaed;">

<!-- Reusable Navbar -->
<script type="text/javascript" src="js/navbar.js"></script>
<script>renderNavbar('single-destination');</script>

<!-- 로그인/회원가입/프로필은 toss-auth.js가 자동 주입합니다. -->

<!-- 사용자 정보 수정 모달 -->
<div class="profile-modal" id="profileModal">
	<div class="profile-modal-content">
		<div class="profile-modal-header">
			<h3>내 정보 수정</h3>
			<span class="close" id="closeProfileModal">&times;</span>
		</div>
		<div class="profile-modal-body">
			<form id="profileForm">
				<div class="form-input">
					<label>이름</label>
					<input type="text" id="profileName" class="form-control" required>
				</div>
				<div class="form-input">
					<label>이메일</label>
					<input type="email" id="profileEmail" class="form-control" required>
				</div>
				<div class="form-input">
					<label>전화번호</label>
					<input type="tel" id="profilePhone" class="form-control" required>
				</div>
				<div class="form-input">
					<label>새 비밀번호 (변경하지 않으려면 비워두세요)</label>
					<input type="password" id="profilePassword" class="form-control" minlength="6">
				</div>
				<div class="form-input">
					<label>새 비밀번호 확인</label>
					<input type="password" id="profilePasswordConfirm" class="form-control" minlength="6">
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-orange">수정하기</button>
					<button type="button" class="btn btn-secondary" id="cancelProfileEdit">취소</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Section -->

<section class="section-ticket">
	<div class="header">
		<img id="destination-image" src="img/elephant.jpg" alt="">
		<div class="overlay">
			<div class="desc">
				<h3 id="destination-title">로딩 중...</h3>
				<div id="destination-rating">
					<!-- 별점이 동적으로 로드됩니다 -->
				</div>
			</div>
		</div>
	</div>
	<div class="body">
		<div class="panel">
			<div class="panel-header">
				<span class="ion-android-clipboard"></span>&nbsp; 티켓 상세정보
			</div>
			<div class="panel-body">
				<div class="detail">
					<div class="col-1" id="destination-details">
						<!-- 여행지 상세정보가 동적으로 로드됩니다 -->
					</div>
					<div class="col-2">
						<b>시작가</b>
						<h2 id="destination-price"><b style="color: #f25601">로딩 중... </b><small>/ 1인</small></h2> <br>
						<a href="" data-slide="slides" data-slide-target="#find" class="btn-ticket btn-orange">티켓 찾기</a>
					</div>
				</div>
			</div>
		</div>
		<div class="panel">
			<div class="panel-header">
				<span class="ion-ios-bookmarks"></span>&nbsp; 상품 설명
			</div>
			<div class="panel-body" id="destination-description">
				<p>로딩 중...</p>
			</div>
		</div>
		<div class="panel">
			<div class="panel-header">
				<span class="ion-ios-bookmarks"></span>&nbsp; 하이라이트
			</div>
			<div class="panel-body" id="destination-highlights">
				<ul>
					<li>로딩 중...</li>
				</ul>
			</div>
		</div>
		<div class="panel">
			<div class="panel-header">
				<span class="ion-ios-map"></span>&nbsp; 위치
			</div>
			<div class="panel-body">
				<div class="col-1" id="destination-map">
					<!-- 지도가 동적으로 로드됩니다 -->
				</div>
				<div class="col-2" id="destination-location-info">
					<h3>교통편 및 장소 정보</h3>
					<p>로딩 중...</p>
				</div>
			</div>
		</div>
		<div class="panel">
			<div class="panel-body">
				<form class="form-horizontal" id="bookingForm">
					<div class="input-form">
						<label>날짜 선택</label>
						<input type="date" name="travelDate" id="travelDate" class="form-control" required>
					</div>
					<div class="input-form">
						<label>인원 수</label>
						<select class="form-control" name="paxCount" id="paxCount" required>
							<option value="1">1명</option>
							<option value="2">2명</option>
							<option value="3">3명</option>
							<option value="4">4명</option>
						</select>
					</div>
					<div class="input-form">
						<label>총 결제 금액</label>
						<div class="total-price" style="font-size: 24px; font-weight: bold; color: #f25601; margin-top: 10px;">
							₩ 120,000
						</div>
					</div>
					<div class="input-form" id="find">
						<label></label>
						<button type="button" class="btn btn-ticket btn-orange" style="margin-top: 37px;text-align: right;" id="paymentButton">구매하기</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</section>

<!-- Footer (reusable) -->
<script type="text/javascript" src="js/footer.js"></script>
<script>renderFooter();</script>

    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
    // 초기 페이지 로딩 스켈레톤
    if (window.showPageSkeleton) {
      window.showPageSkeleton();
      window.addEventListener('load', function(){ if (window.hidePageSkeleton) window.hidePageSkeleton(); });
    }
    </script>
    <script type="text/javascript" src="js/jquery.swipebox.min.js"></script>
    
    <script>
        // 현재 여행지 정보를 저장할 변수
        let currentDestination = null;

        // URL에서 slug 추출
        function getSlugFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug');
            if (slug) {
                return slug;
            }
            // URL 파라미터가 없으면 기존 방식으로 path에서 추출
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        // 여행지 상세 정보 로드
        async function loadDestinationDetails() {
            try {
                const slug = getSlugFromUrl();
                const response = await fetch(`/api/destinations/${slug}`);
                
                if (!response.ok) {
                    throw new Error('여행지를 찾을 수 없습니다.');
                }
                
                const destination = await response.json();
                currentDestination = destination;
                
                // 페이지 제목 업데이트
                document.title = `${destination.title} - 트립페이지`;
                
                // 헤더 정보 업데이트
                document.getElementById('destination-image').src = destination.image_url;
                document.getElementById('destination-image').alt = destination.name;
                document.getElementById('destination-title').textContent = destination.title;
                
                // 별점 표시
                const rating = Math.floor(destination.rating);
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= rating) {
                        starsHtml += '<span class="ion-ios-star checked"></span>';
                    } else {
                        starsHtml += '<span class="ion-ios-star"></span>';
                    }
                }
                document.getElementById('destination-rating').innerHTML = starsHtml;
                
                // 상세 정보 업데이트
                const detailsHtml = `
                    <div class="col">
                        <span class="ion-clock"></span> ${destination.schedule || '08:00 - 16:00'}
                    </div>
                    <div class="col">
                        <span class="ion-person-stalker"></span> 최소 ${destination.min_participants}명 | 최대 ${destination.max_participants}명
                    </div>
                    ${destination.includes ? destination.includes.map(item => `
                    <div class="col">
                        <span class="ion-checkmark-round"></span> ${item}
                    </div>
                    `).join('') : ''}
                `;
                document.getElementById('destination-details').innerHTML = detailsHtml;
                
                // 가격 정보 업데이트
                const priceDisplay = destination.price_max 
                    ? `₩ ${destination.price_min.toLocaleString()} - ₩ ${destination.price_max.toLocaleString()}`
                    : `₩ ${destination.price_min.toLocaleString()}`;
                document.getElementById('destination-price').innerHTML = `<b style="color: #f25601">${priceDisplay} </b><small>/ 1인</small>`;
                
                // 설명 업데이트
                document.getElementById('destination-description').innerHTML = `<p>${destination.description || '상세 설명이 없습니다.'}</p>`;
                
                // 하이라이트 업데이트
                if (destination.highlights && destination.highlights.length > 0) {
                    const highlightsHtml = destination.highlights.map(highlight => `<li>${highlight}</li>`).join('');
                    document.getElementById('destination-highlights').innerHTML = `<ul>${highlightsHtml}</ul>`;
                } else {
                    document.getElementById('destination-highlights').innerHTML = '<ul><li>하이라이트 정보가 없습니다.</li></ul>';
                }
                
                // 위치 정보 업데이트
                if (destination.map_embed_url) {
                    document.getElementById('destination-map').innerHTML = `<iframe src="${destination.map_embed_url}" width="600" height="450" frameborder="0" style="border:0" allowfullscreen></iframe>`;
                } else {
                    document.getElementById('destination-map').innerHTML = '<p>지도 정보가 없습니다.</p>';
                }
                
                document.getElementById('destination-location-info').innerHTML = `
                    <h3>교통편 및 장소 정보</h3>
                    <p>${destination.location_info || '위치 정보가 없습니다.'}</p>
                `;
                
                // 총 금액 초기화
                updateTotalPrice();
                
            } catch (error) {
                console.error('여행지 정보 로드 실패:', error);
                document.getElementById('destination-title').textContent = '여행지 정보를 불러올 수 없습니다.';
                document.getElementById('destination-description').innerHTML = '<p>여행지 정보를 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.</p>';
            }
        }

        // 총 금액 업데이트 함수
        function updateTotalPrice() {
            if (!currentDestination) return;
            
            const paxCount = parseInt(document.getElementById('paxCount').value);
            const basePrice = currentDestination.price_min;
            const totalPrice = basePrice * paxCount;
            
            document.querySelector('.total-price').innerHTML = `₩ ${totalPrice.toLocaleString()}`;
        }

        // 구매하기 버튼 클릭 이벤트
        document.getElementById('paymentButton').addEventListener('click', function() {
            // 폼 데이터 수집
            const travelDate = document.getElementById('travelDate').value;
            const paxCount = document.getElementById('paxCount').value;
            
            // 필수 정보 검증
            if (!travelDate) {
                showErrorToast('여행 날짜를 선택해주세요.');
                return;
            }
            
            if (!paxCount) {
                showErrorToast('인원 수를 선택해주세요.');
                return;
            }
            
            // 주문서 페이지로 이동 (URL 파라미터로 정보 전달)
            const checkoutUrl = `checkout-demo.html?date=${encodeURIComponent(travelDate)}&pax=${encodeURIComponent(paxCount)}`;
            window.location.href = checkoutUrl;
        });
        
        // 인원 수 변경 시 총 금액 업데이트
        document.getElementById('paxCount').addEventListener('change', function() {
            updateTotalPrice();
        });
        
        // 티켓 찾기 버튼 클릭 시 아래 주문 폼으로 스크롤
        document.querySelector('.btn-ticket').addEventListener('click', function(e) {
            e.preventDefault();
            const targetElement = document.getElementById('find');
            if (targetElement) {
                targetElement.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 여행지 정보 로드
            loadDestinationDetails();
            
            // 오늘 날짜를 최소 선택 가능 날짜로 설정
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const tomorrowString = tomorrow.toISOString().split('T')[0];
            document.getElementById('travelDate').min = tomorrowString;
        });
        
        // 스크롤 이벤트로 navbar 스타일 변경
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            const scrollPosition = window.scrollY;
            
            if (scrollPosition > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });
        
        // 사이드바 디버깅
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료');
            
            // jQuery 확인
            if (typeof $ !== 'undefined') {
                console.log('jQuery 로드됨');
                
                // 사이드바 토글 버튼 확인
                const sidebarToggle = $('.sidebar-toggle');
                console.log('사이드바 토글 버튼:', sidebarToggle.length);
                
                // 수동으로 이벤트 추가 (백업)
                $('.sidebar-toggle').off('click').on('click', function(e) {
                    console.log('사이드바 토글 클릭됨');
                    e.preventDefault();
                    $('.sidebar').addClass('active');
                    $('.sidebar-overlay').css('visibility', 'visible');
                });
                
                $('.sidebar-overlay, .close').off('click').on('click', function(e) {
                    console.log('사이드바 닫기 클릭됨');
                    e.preventDefault();
                    $('.sidebar').removeClass('active');
                    $('.sidebar-overlay').css('visibility', 'hidden');
                });
            } else {
                console.error('jQuery가 로드되지 않았습니다');
            }
        });

        // 프로필 모달 관련 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            // 프로필 모달 열기
            const openProfileModal = document.getElementById('openProfileModal');
            const profileModal = document.getElementById('profileModal');
            
            if (openProfileModal && profileModal) {
                openProfileModal.addEventListener('click', function(e) {
                    e.preventDefault();
                    profileModal.style.display = 'block';
                    
                    // 현재 사용자 정보로 폼 채우기
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser.name) {
                        document.getElementById('profileName').value = currentUser.name;
                    }
                    if (currentUser.email) {
                        document.getElementById('profileEmail').value = currentUser.email;
                    }
                    if (currentUser.phone) {
                        document.getElementById('profilePhone').value = currentUser.phone;
                    }
                    
                    // 실시간 중복 검증 설정
                    setupProfileValidation(currentUser.id);
                });
            }
            
            // 프로필 모달 닫기
            const closeProfileModal = document.getElementById('closeProfileModal');
            const cancelProfileEdit = document.getElementById('cancelProfileEdit');
            
            if (closeProfileModal && profileModal) {
                closeProfileModal.addEventListener('click', function() {
                    profileModal.style.display = 'none';
                });
            }
            
            if (cancelProfileEdit && profileModal) {
                cancelProfileEdit.addEventListener('click', function() {
                    profileModal.style.display = 'none';
                });
            }
            
            // 모달 외부 클릭 시 닫기
            if (profileModal) {
                profileModal.addEventListener('click', function(e) {
                    if (e.target === profileModal) {
                        profileModal.style.display = 'none';
                    }
                });
            }
            
            // 프로필 폼 제출 처리
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('profileName').value;
                    const email = document.getElementById('profileEmail').value;
                    const phone = document.getElementById('profilePhone').value;
                    const password = document.getElementById('profilePassword').value;
                    const passwordConfirm = document.getElementById('profilePasswordConfirm').value;
                    
                    // 비밀번호 확인
                    if (password && password !== passwordConfirm) {
                        showProfileError('새 비밀번호 확인', '비밀번호가 일치하지 않습니다.');
                        return;
                    }
                    
                    // 중복 검증
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    const emailValidation = validateEmailUniqueness(email, currentUser.id);
                    const phoneValidation = validatePhoneUniqueness(phone, currentUser.id);
                    
                    if (!emailValidation.isValid) {
                        showProfileError('이메일', emailValidation.message);
                        return;
                    }
                    
                    if (!phoneValidation.isValid) {
                        showProfileError('전화번호', phoneValidation.message);
                        return;
                    }
                    
                    // 사용자 정보 업데이트
                    const updatedUser = {
                        ...currentUser,
                        name: name,
                        email: email,
                        phone: phone
                    };
                    
                    if (password) {
                        updatedUser.password = password;
                    }
                    
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    
                    // 성공 메시지
                    showProfileSuccess('프로필이 성공적으로 업데이트되었습니다.');
                    setTimeout(() => {
                        profileModal.style.display = 'none';
                    }, 1500);
                    
                    // 폼 초기화
                    profileForm.reset();
                });
            }
        });

        // 프로필 검증 설정
        function setupProfileValidation(currentUserId) {
            const emailInput = document.getElementById('profileEmail');
            const phoneInput = document.getElementById('profilePhone');
            
            // 이메일 실시간 검증
            if (emailInput) {
                let emailTimeout;
                emailInput.addEventListener('input', function() {
                    clearTimeout(emailTimeout);
                    const email = this.value.trim();
                    
                    if (email === '') {
                        hideProfileError('이메일');
                        return;
                    }
                    
                    if (!isValidEmail(email)) {
                        showProfileError('이메일', '올바른 이메일 형식을 입력해주세요');
                        return;
                    }
                    
                    emailTimeout = setTimeout(() => {
                        const validation = validateEmailUniqueness(email, currentUserId);
                        if (!validation.isValid) {
                            showProfileError('이메일', validation.message);
                        } else {
                            hideProfileError('이메일');
                        }
                    }, 500);
                });
            }
            
            // 전화번호 실시간 검증
            if (phoneInput) {
                let phoneTimeout;
                phoneInput.addEventListener('input', function() {
                    clearTimeout(phoneTimeout);
                    const phone = this.value.trim();
                    
                    if (phone === '') {
                        hideProfileError('전화번호');
                        return;
                    }
                    
                    if (!isValidPhone(phone)) {
                        showProfileError('전화번호', '올바른 전화번호 형식을 입력해주세요');
                        return;
                    }
                    
                    phoneTimeout = setTimeout(() => {
                        const validation = validatePhoneUniqueness(phone, currentUserId);
                        if (!validation.isValid) {
                            showProfileError('전화번호', validation.message);
                        } else {
                            hideProfileError('전화번호');
                        }
                    }, 500);
                });
            }
        }

        // 프로필 에러 표시
        function showProfileError(fieldName, message) {
            const labels = document.querySelectorAll('label');
            let targetField = null;
            
            for (let label of labels) {
                if (label.textContent.includes(fieldName)) {
                    targetField = label.closest('.form-input');
                    break;
                }
            }
            
            if (!targetField) return;
            
            let errorElement = targetField.querySelector('.profile-error');
            
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'profile-error';
                errorElement.innerHTML = '<span style="color: #dc3545;">⚠</span>' + message;
                targetField.appendChild(errorElement);
            } else {
                errorElement.innerHTML = '<span style="color: #dc3545;">⚠</span>' + message;
                errorElement.style.display = 'block';
            }
            
            // 에러 상태 클래스 추가
            targetField.classList.add('error');
        }

        // 프로필 에러 숨기기
        function hideProfileError(fieldName) {
            const labels = document.querySelectorAll('label');
            let targetField = null;
            
            for (let label of labels) {
                if (label.textContent.includes(fieldName)) {
                    targetField = label.closest('.form-input');
                    break;
                }
            }
            
            if (!targetField) return;
            
            const errorElement = targetField.querySelector('.profile-error');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // 에러 상태 클래스 제거
            targetField.classList.remove('error');
        }

        // 프로필 성공 메시지
        function showProfileSuccess(message) {
            const successElement = document.createElement('div');
            successElement.className = 'profile-success';
            successElement.style.cssText = 'background: #d4edda; color: #155724; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 500;';
            successElement.textContent = message;
            
            const form = document.getElementById('profileForm');
            form.insertBefore(successElement, form.firstChild);
            
            setTimeout(() => {
                successElement.remove();
            }, 3000);
        }

        // 이메일 형식 검증
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // 전화번호 형식 검증
        function isValidPhone(phone) {
            const phoneRegex = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/;
            return phoneRegex.test(phone);
        }

        // 이메일 중복 검증
        function validateEmailUniqueness(email, currentUserId = null) {
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const duplicateUser = existingUsers.find(user => 
                user.email === email && user.id !== currentUserId
            );
            
            if (duplicateUser) {
                return {
                    isValid: false,
                    message: '이미 사용 중인 이메일입니다'
                };
            }
            
            return { isValid: true };
        }

        // 전화번호 중복 검증
        function validatePhoneUniqueness(phone, currentUserId = null) {
            if (!phone) return { isValid: true };
            
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const duplicateUser = existingUsers.find(user => 
                user.phone === phone && user.id !== currentUserId
            );
            
            if (duplicateUser) {
                return {
                    isValid: false,
                    message: '이미 사용 중인 전화번호입니다'
                };
            }
            
            return { isValid: true };
        }
    </script>

</body>
</html>