<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>해외여행지 - 트립페이지</title>
	<link rel="icon" type="image/png" href="img/icon/bavel.png">

	<!-- Meta Description -->
	<meta name="description" content="트립페이지 - 해외여행 상품 판매 및 여행 정보 제공">
	<meta name="keywords" content="해외여행, 여행상품, 여행사, 여행정보, 여행가이드, 패키지여행">
	<meta name="robots" content="index, nofollow">
	<meta name="web_author" content="트립페이지">
	<meta name="language" content="Korean">  

	<!-- Import Icon -->
  	<link rel="stylesheet" type="text/css" href="css/ionicons.min.css">

	<!-- Import Style -->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/swiper.css">
	<link rel="stylesheet" type="text/css" href="css/destination.css">

</head>
<body>

<!-- Reusable Navbar -->
<script type="text/javascript" src="js/navbar.js"></script>
<script>renderNavbar('destination');</script>

<!-- 공용 사이드바(navbar.js)로 대체됨 -->

<!-- 기존 로그인 폼 제거: 자동 주입 사용 -->
<div class="login-form" style="display:none;">
	<div class="login-top">
		<span class="close">&times;</span>
	</div>
	<div class="login">
		<h3 class="text-center">
			트립페이지 로그인
		</h3>
		<div class="form-input">
			<label>이메일</label> <br>
			<input type="email" name="" class="form-control">
		</div>
		<div class="form-input">
			<label>비밀번호</label> <br>
			<input type="password" name="" class="form-control">
		</div>
		<div class="form-input">
			<button type="submit" class="btn btn-login">로그인</button>
		</div>
		<a href="" class="text-center">계정이 없으신가요? 회원가입하기</a>
	</div>
</div>

<div class="login-overlay" style="display:none;"></div>

<!-- 사용자 정보 수정 모달 -->
<div class="profile-modal" id="profileModal">
	<div class="profile-modal-content">
		<div class="profile-modal-header">
			<h3>내 정보 수정</h3>
			<span class="close" id="closeProfileModal">&times;</span>
		</div>
		<div class="profile-modal-body">
			<form id="profileForm">
				<div class="form-input">
					<label>이름</label>
					<input type="text" id="profileName" class="form-control" required>
				</div>
				<div class="form-input">
					<label>이메일</label>
					<input type="email" id="profileEmail" class="form-control" required>
				</div>
				<div class="form-input">
					<label>전화번호</label>
					<input type="tel" id="profilePhone" class="form-control" required>
				</div>
				<div class="form-input">
					<label>새 비밀번호 (변경하지 않으려면 비워두세요)</label>
					<input type="password" id="profilePassword" class="form-control" minlength="6">
				</div>
				<div class="form-input">
					<label>새 비밀번호 확인</label>
					<input type="password" id="profilePasswordConfirm" class="form-control" minlength="6">
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-orange">수정하기</button>
					<button type="button" class="btn btn-secondary" id="cancelProfileEdit">취소</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- 여행상품 추가 모달 -->
<div class="destination-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
	<div class="destination-modal-content" style="position: relative; background: white; margin: 50px auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 800px;">
		<div class="destination-modal-header" style="text-align: center; margin-bottom: 30px;">
			<h3>여행상품 추가</h3>
			<span class="close-destination" style="position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer;">&times;</span>
		</div>
		<form id="destinationForm">
			<div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
				<div class="form-group" style="flex: 1;">
					<label>여행지명 *</label>
					<input type="text" id="destName" class="form-control" required>
				</div>
				<div class="form-group" style="flex: 1;">
					<label>제목 *</label>
					<input type="text" id="destTitle" class="form-control" required>
				</div>
			</div>
			<div class="form-group" style="margin-bottom: 20px;">
				<label>설명</label>
				<textarea id="destDescription" class="form-control" rows="3"></textarea>
			</div>
			<div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
				<div class="form-group" style="flex: 1;">
					<label>최소 가격 *</label>
					<input type="number" id="destPriceMin" class="form-control" required>
				</div>
				<div class="form-group" style="flex: 1;">
					<label>최대 가격</label>
					<input type="number" id="destPriceMax" class="form-control">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>평점 (1-5)</label>
					<input type="number" id="destRating" class="form-control" min="1" max="5" step="0.1" value="4.0">
				</div>
			</div>
			<div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
				<div class="form-group" style="flex: 1;">
					<label>이미지 URL</label>
					<input type="url" id="destImageUrl" class="form-control" placeholder="https://example.com/image.jpg">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>위치 정보</label>
					<input type="text" id="destLocation" class="form-control">
				</div>
			</div>
			<div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
				<div class="form-group" style="flex: 1;">
					<label>일정</label>
					<input type="text" id="destSchedule" class="form-control" placeholder="08:00 - 18:00">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>최소 참가자</label>
					<input type="number" id="destMinParticipants" class="form-control" value="1" min="1">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>최대 참가자</label>
					<input type="number" id="destMaxParticipants" class="form-control" value="15" min="1">
				</div>
			</div>
			<div class="form-group" style="margin-bottom: 30px;">
				<label>포함 사항 (쉼표로 구분)</label>
				<input type="text" id="destIncludes" class="form-control" placeholder="입장료, 가이드 서비스, 교통편">
			</div>
			<div class="form-actions" style="text-align: center;">
				<button type="submit" class="btn btn-orange" style="margin-right: 10px;">상품 추가</button>
				<button type="button" class="btn btn-secondary close-destination">취소</button>
			</div>
		</form>
	</div>
</div>

<section class="section-header-single">
	<img src="img/bg-destination.jpg">
	<div class="overlay">
		<div class="header-title">
			<h3>해외여행지 상품</h3>	
			<span class="ion-record"></span>&nbsp;
			<span class="ion-record"></span>&nbsp;
			<span class="ion-record"></span>
		</div>
	</section>
</section>

<ul class="breadcrumb">
  <li><a href="index.html">홈</a></li>
  <li>해외여행지</li>
</ul>

<section class="section section-single">
	<div class="container-fluid">
		<div class="single-head">
			<div class="col">
				<img src="img/icon/destination.png">
				<h3>지금 바로 당신의 해외여행지를 찾아보세요!</h3>
				<p>합리적인 가격으로 제공되는 다양한 해외여행지 상품들입니다. 원하시는 여행지를 선택해주세요</p>
			</div>
			<div class="col-form">
				<button id="addDestinationBtn" class="btn btn-orange btn-round" style="display: none;">여행상품 추가</button>
			</div>
		</div>
		<div class="single-body" id="destinations-container">
			<!-- 여행지 목록이 동적으로 로드됩니다 -->
		</div>
	</div>
</section>

<ul class="pagination" id="destination-pagination">
	<!-- 페이지네이션이 동적으로 로드됩니다 -->
</ul>

<!-- Footer (reusable) -->
<script type="text/javascript" src="js/footer.js"></script>
<script>renderFooter();</script>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/main.js"></script>
<script>
// 초기 페이지 로딩 스켈레톤
if (window.showPageSkeleton) {
  window.showPageSkeleton();
  window.addEventListener('load', function(){ if (window.hidePageSkeleton) window.hidePageSkeleton(); });
}
</script>
<script type="text/javascript" src="js/toss-auth.js"></script>
<script type="text/javascript" src="js/swipe.js"></script>
<script type="text/javascript" src="js/pagination.js"></script>

<script>
function isAdminUser() {
    try {
        const u = JSON.parse(localStorage.getItem('currentUser'));
        return !!u && u.email === 'admin@trippage.com';
    } catch (e) { return false; }
}

// 여행지 목록 로드 (페이지네이션)
async function loadDestinations(page = 1, pageSize = 9) {
    try {
        if (window.showPageSkeleton) window.showPageSkeleton();
        const response = await fetch(`/api/destinations?page=${page}&pageSize=${pageSize}`);
        const data = await response.json();
        
        const container = document.getElementById('destinations-container');
        container.innerHTML = '';
        const destinations = data.items || [];

        destinations.forEach(destination => {
            const priceDisplay = destination.price_max 
                ? `₩ ${destination.price_min.toLocaleString()} - ₩ ${destination.price_max.toLocaleString()}`
                : `₩ ${destination.price_min.toLocaleString()}`;
            
            // 별점 표시 생성
            const rating = Math.floor(destination.rating);
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<span class="ion-ios-star checked"></span>';
                } else {
                    starsHtml += '<span class="ion-ios-star"></span>';
                }
            }
            
            const canAdmin = isAdminUser();
            const destinationHtml = `
                <div class="col">
                    <img src="${destination.image_url}" alt="${destination.name}">
                    <div class="overlay">
                        <div class="caption">
                            <div class="caption-text">
                                <p>${destination.name}</p>
                                ${starsHtml} <br>
                                <span class="ion-bag big"></span> &nbsp;
                                <b>${priceDisplay}</b> <br>
                                <a href="single-destination.html?slug=${destination.slug}" class="btn btn-orange btn-round">상세보기</a>
                                ${canAdmin ? `<button class="btn btn-secondary btn-round" data-action="delete-dest" data-id="${destination.id}" style="margin-left:8px;">삭제</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += destinationHtml;
        });

        // 페이지네이션 렌더링
        renderPagination('destination-pagination', data.page, data.totalPages, loadDestinations);
    } catch (error) {
        console.error('여행지 목록 로드 실패:', error);
        const container = document.getElementById('destinations-container');
        container.innerHTML = '<p style="text-align: center; color: #f25601; padding: 20px;">여행지 목록을 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.</p>';
    }
    finally {
        if (window.hidePageSkeleton) window.hidePageSkeleton();
    }
}

// 페이지 로드 시 여행지 목록 로드
document.addEventListener('DOMContentLoaded', function(){
    // 관리자면 생성 버튼 보이기
    if (isAdminUser()) {
        const btn = document.getElementById('addDestinationBtn');
        if (btn) btn.style.display = 'inline-block';
    }
    loadDestinations(1, 9);
});

// 여행상품 추가 버튼 클릭
document.getElementById('addDestinationBtn').addEventListener('click', () => {
    document.querySelector('.destination-modal').style.display = 'block';
});

// 여행상품 추가 모달 닫기
document.querySelectorAll('.close-destination').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelector('.destination-modal').style.display = 'none';
    });
});

// 삭제 이벤트 위임
document.getElementById('destinations-container').addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action="delete-dest"]');
    if (!btn) return;
    e.preventDefault();
    const id = btn.getAttribute('data-id');
    if (!id) return;
    if (!confirm('정말 삭제하시겠습니까?')) return;
    try {
        const res = await fetch(`/api/admin/destinations/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('삭제 실패');
        await loadDestinations(1, 9);
    } catch (err) {
        showErrorToast('삭제 중 오류가 발생했습니다.');
    }
});

// 여행상품 추가 폼 제출
document.getElementById('destinationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('destName').value,
        title: document.getElementById('destTitle').value,
        description: document.getElementById('destDescription').value,
        price_min: parseInt(document.getElementById('destPriceMin').value),
        price_max: document.getElementById('destPriceMax').value ? parseInt(document.getElementById('destPriceMax').value) : null,
        rating: parseFloat(document.getElementById('destRating').value),
        image_url: document.getElementById('destImageUrl').value || 'img/temple.jpg',
        location_info: document.getElementById('destLocation').value,
        schedule: document.getElementById('destSchedule').value,
        min_participants: parseInt(document.getElementById('destMinParticipants').value),
        max_participants: parseInt(document.getElementById('destMaxParticipants').value),
        includes: document.getElementById('destIncludes').value ? document.getElementById('destIncludes').value.split(',').map(item => item.trim()) : []
    };
    
    try {
        const response = await fetch('/api/admin/destinations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessToast('여행상품이 성공적으로 추가되었습니다!');
            document.querySelector('.destination-modal').style.display = 'none';
            
            // 폼 초기화
            document.getElementById('destinationForm').reset();
            document.getElementById('destRating').value = '4.0';
            document.getElementById('destMinParticipants').value = '1';
            document.getElementById('destMaxParticipants').value = '15';
            
            // 여행지 목록 새로고침
            loadDestinations();
        } else {
            showErrorToast('여행상품 추가에 실패했습니다: ' + result.error);
        }
    } catch (error) {
        console.error('여행상품 추가 오류:', error);
        showErrorToast('여행상품 추가 중 오류가 발생했습니다.');
    }
});
</script>
</body>
</html>