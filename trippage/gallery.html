<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>갤러리 - 트립페이지</title>
	<link rel="icon" type="image/png" href="img/icon/bavel.png">

	<!-- Meta Description -->
	<meta name="description" content="트립페이지 - 여행 갤러리">
	<meta name="keywords" content="해외여행, 여행사진, 갤러리, 여행추억">
	<meta name="robots" content="index, nofollow">
	<meta name="web_author" content="트립페이지">
	<meta name="language" content="Korean">  

	<!-- Import Icon -->
  	<link rel="stylesheet" type="text/css" href="css/ionicons.min.css">

	<!-- Import Style -->
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/swiper.css">
	<link rel="stylesheet" type="text/css" href="css/gallery.css">

</head>
<body>

<!-- Reusable Navbar -->
<script type="text/javascript" src="js/navbar.js"></script>
<script>renderNavbar('gallery');</script>

<!-- 사용자 정보 수정 모달 -->
<div class="profile-modal" id="profileModal">
	<div class="profile-modal-content">
		<div class="profile-modal-header">
			<h3>내 정보 수정</h3>
			<span class="close" id="closeProfileModal">&times;</span>
		</div>
		<div class="profile-modal-body">
			<form id="profileForm">
				<div class="form-input">
					<label>이름</label>
					<input type="text" id="profileName" class="form-control" required>
				</div>
				<div class="form-input">
					<label>이메일</label>
					<input type="email" id="profileEmail" class="form-control" required>
				</div>
				<div class="form-input">
					<label>전화번호</label>
					<input type="tel" id="profilePhone" class="form-control" required>
				</div>
				<div class="form-input">
					<label>새 비밀번호 (변경하지 않으려면 비워두세요)</label>
					<input type="password" id="profilePassword" class="form-control" minlength="6">
				</div>
				<div class="form-input">
					<label>새 비밀번호 확인</label>
					<input type="password" id="profilePasswordConfirm" class="form-control" minlength="6">
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-orange">수정하기</button>
					<button type="button" class="btn btn-secondary" id="cancelProfileEdit">취소</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- 사진 추가 모달 -->
<div class="image-modal" style="display: none;">
	<div class="image-modal-content">
		<div class="image-modal-header">
			<h3>갤러리 사진 추가</h3>
			<span class="close-image">&times;</span>
		</div>
		<form id="imageForm">
			<div class="form-group">
				<label for="imageFile">이미지 파일 *</label>
				<input type="file" id="imageFile" class="form-control" name="image" accept="image/*" required>
			</div>
			<div class="form-group">
				<label for="altText">대체 텍스트</label>
				<input type="text" id="altText" class="form-control" name="alt_text" placeholder="예: 발리의 아름다운 해변">
			</div>
			<div class="form-group" style="display: flex; align-items: center;">
				<input type="checkbox" id="isFeatured" name="is_featured" value="true" style="width: auto; margin-right: 10px;">
				<label for="isFeatured" style="margin-bottom: 0;">메인에 추천 이미지로 표시</label>
			</div>
			<div class="form-actions">
				<button type="submit" class="btn btn-orange">사진 추가</button>
				<button type="button" class="btn btn-secondary close-image">취소</button>
			</div>
		</form>
	</div>
</div>


<section class="section-header-single">
	<img src="img/bg-gallery.jpg">
	<div class="overlay">
		<div class="header-title">
			<h3>여행 갤러리</h3>	
			<span class="ion-record"></span>&nbsp;
			<span class="ion-record"></span>&nbsp;
			<span class="ion-record"></span>
		</div>
	</section>
</section>

<ul class="breadcrumb">
  <li><a href="index.html">홈</a></li>
  <li>갤러리</li>
</ul>

<section class="section section-single">
	<div class="container-fluid">
		<div class="single-head">
			<div class="col">
				<img src="img/icon/gallery.png">
				<h3>아름다운 여행의 순간들</h3>
				<p>트립페이지와 함께한 고객님들의 소중한 추억을 공유합니다.</p>
			</div>
			<div class="col-form">
				<button id="addImageBtn" class="btn btn-orange btn-round" style="display: none;">사진 추가</button>
			</div>
		</div>
		<div class="single-body" id="gallery-container">
			<!-- 갤러리 이미지가 동적으로 로드됩니다 -->
		</div>
	</div>
</section>

<ul class="pagination" id="gallery-pagination">
	<!-- 페이지네이션이 동적으로 로드됩니다 -->
</ul>

<!-- Footer (reusable) -->
<script type="text/javascript" src="js/footer.js"></script>
<script>renderFooter();</script>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/main.js"></script>
<script>
// 초기 페이지 로딩 스켈레톤
if (window.showPageSkeleton) {
  window.showPageSkeleton();
  window.addEventListener('load', function(){ if (window.hidePageSkeleton) window.hidePageSkeleton(); });
}
</script>
<script type="text/javascript" src="js/toss-auth.js"></script>
<script type="text/javascript" src="js/swipe.js"></script>

<script>
function isAdminUser() {
    try {
        const u = JSON.parse(localStorage.getItem('currentUser'));
        return !!u && u.email === 'admin@trippage.com';
    } catch (e) { return false; }
}

// 갤러리 목록 로드 (페이지네이션)
async function loadGallery(page = 1, pageSize = 12) {
    try {
        if (window.showPageSkeleton) window.showPageSkeleton();
        const response = await fetch(`/api/gallery?page=${page}&pageSize=${pageSize}`);
        const data = await response.json();
        
        const container = document.getElementById('gallery-container');
        container.innerHTML = '';
        const images = data.items || [];

        images.forEach(image => {
            const canAdmin = isAdminUser();
            const imageHtml = `
                <div class="col">
                    <img src="${image.image_url}" alt="${image.alt_text || '갤러리 이미지'}">
                    <div class="overlay">
                        <div class="caption">
                            <div class="caption-text">
                                <p>${image.alt_text || '트립페이지 갤러리'}</p>
                                ${canAdmin ? `<button class="btn btn-secondary btn-round" data-action="delete-image" data-id="${image.id}">삭제</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += imageHtml;
        });

        // 페이지네이션 렌더링
        renderGalleryPagination(data.page, data.totalPages);
    } catch (error) {
        console.error('갤러리 로드 실패:', error);
        const container = document.getElementById('gallery-container');
        container.innerHTML = '<p style="text-align: center; color: #f25601; padding: 20px; width: 100%;">갤러리 이미지를 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.</p>';
    }
    finally {
        if (window.hidePageSkeleton) window.hidePageSkeleton();
    }
}

function renderGalleryPagination(current, total) {
    const pag = document.getElementById('gallery-pagination');
    if (!pag) return;
    pag.innerHTML = '';

    function addPage(label, pageNum, disabled = false, active = false) {
        const a = document.createElement('a');
        a.href = '#';
        a.className = active ? 'pagin-number active' : (label === 'prev' || label === 'next' ? 'pagination-arrow' : 'pagin-number');
        if (label === 'prev') a.classList.add('arrow-left');
        if (label === 'next') a.classList.add('arrow-right');
        a.innerHTML = label === 'prev' ? '<span class="ion-ios-arrow-back"></span>' : (label === 'next' ? '<span class="ion-ios-arrow-forward"></span>' : String(pageNum));
        if (disabled) a.style.pointerEvents = 'none';
        a.addEventListener('click', function(e){ e.preventDefault(); if (!disabled) loadGallery(pageNum); });
        pag.appendChild(a);
    }

    addPage('prev', Math.max(1, current - 1), current === 1);
    const start = Math.max(1, current - 2);
    const end = Math.min(total, start + 4);
    for (let p = start; p <= end; p++) {
        addPage(null, p, false, p === current);
    }
    addPage('next', Math.min(total, current + 1), current === total);
}

// 페이지 로드 시 갤러리 목록 로드
document.addEventListener('DOMContentLoaded', function(){
    // 관리자면 '사진 추가' 버튼 보이기
    if (isAdminUser()) {
        const btn = document.getElementById('addImageBtn');
        if (btn) btn.style.display = 'inline-block';
    }
    loadGallery(1, 12);
});

// 사진 추가 버튼 클릭
document.getElementById('addImageBtn').addEventListener('click', () => {
    document.querySelector('.image-modal').style.display = 'block';
});

// 사진 추가 모달 닫기
document.querySelectorAll('.close-image').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelector('.image-modal').style.display = 'none';
    });
});

// 삭제 이벤트 위임
document.getElementById('gallery-container').addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-action="delete-image"]');
    if (!btn) return;
    e.preventDefault();
    const id = btn.getAttribute('data-id');
    if (!id) return;
    if (!confirm('정말 삭제하시겠습니까?')) return;
    try {
        const res = await fetch(`/api/admin/gallery/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (!result.success) throw new Error(result.error || '삭제 실패');
        await loadGallery(1, 12);
        showSuccessToast('이미지가 삭제되었습니다.');
    } catch (err) {
        showErrorToast('삭제 중 오류가 발생했습니다.');
    }
});

// 사진 추가 폼 제출
document.getElementById('imageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    const imageFile = formData.get('image');
    if (!imageFile || imageFile.size === 0) {
        showErrorToast('이미지 파일을 선택해주세요.');
        return;
    }

    try {
        const response = await fetch('/api/admin/gallery', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessToast('갤러리 이미지가 성공적으로 추가되었습니다!');
            document.querySelector('.image-modal').style.display = 'none';
            document.getElementById('imageForm').reset();
            loadGallery();
        } else {
            showErrorToast('이미지 추가에 실패했습니다: ' + result.error);
        }
    } catch (error) {
        console.error('이미지 추가 오류:', error);
        showErrorToast('이미지 추가 중 오류가 발생했습니다.');
    }
});
</script>
</body>
</html>